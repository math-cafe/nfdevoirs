% ============================================================================
% nf-correction-base.sty - Environnement correction pour nfdevoirs
% Contient l'environnement correction avec modes inline/end/only/none
% ============================================================================

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{nfdevoirs/nf-correction-base}[2025/10/06 Environnement correction nfdevoirs]

% ============================================================================
% PACKAGES REQUIS
% ============================================================================
\RequirePackage{tcolorbox}
\RequirePackage{environ}
\RequirePackage{fontawesome5}
\RequirePackage{etoolbox}

% Configuration tcolorbox pour les corrections
\tcbuselibrary{skins,breakable}

% ============================================================================
% ENVIRONNEMENT CORRECTION
% ============================================================================
\NewEnviron{correction}{%
  % Nouveau système basé sur @nfcorrection
  \expandafter\ifstrequal\expandafter{\@nfcorrection}{inline}{%
    % Mode inline : afficher directement
    \begin{tcolorbox}[
      enhanced,
      breakable=false,
      colback=nfcolbglight,
      colframe=nfcolpartie,
      arc=3pt,
      boxrule=1pt,
      left=5pt,
      right=5pt,
      top=5pt,
      bottom=5pt,
      title={\small\textcolor{nfcolpartie}{\faCheck\ Correction}},
      fonttitle=\bfseries,
      coltitle=nfcolpartie,
      attach boxed title to top left={yshift=-2mm, xshift=5mm},
      boxed title style={
        colback=white,
        colframe=nfcolpartie,
        boxrule=1pt,
        arc=2pt
      }
    ]
    \BODY
    \end{tcolorbox}
  }{%
    \expandafter\ifstrequal\expandafter{\@nfcorrection}{end}{%
      % Mode end : stocker chaque correction dans sa propre macro
      \stepcounter{nfcorrection}%
      % Stocker les infos de localisation
      \expandafter\xdef\csname nfcorr\the\value{nfcorrection}partie\endcsname{\Roman{nfpartie}}%
      \expandafter\xdef\csname nfcorr\the\value{nfcorrection}exo\endcsname{\arabic{nfexercice}}%
      \expandafter\xdef\csname nfcorr\the\value{nfcorrection}quest\endcsname{\alph{nfquestion}}%
      % Stocker le contenu de la correction
      \expandafter\global\expandafter\let\csname nfcorr\the\value{nfcorrection}body\endcsname\BODY
    }{%
      \expandafter\ifstrequal\expandafter{\@nfcorrection}{only}{%
        % Mode only : stocker comme pour end, sera affiché en fin sans page de garde
        \stepcounter{nfcorrection}%
        % Stocker les infos de localisation
        \expandafter\xdef\csname nfcorr\the\value{nfcorrection}partie\endcsname{\Roman{nfpartie}}%
        \expandafter\xdef\csname nfcorr\the\value{nfcorrection}exo\endcsname{\arabic{nfexercice}}%
        \expandafter\xdef\csname nfcorr\the\value{nfcorrection}quest\endcsname{\alph{nfquestion}}%
        % Stocker le contenu de la correction
        \expandafter\global\expandafter\let\csname nfcorr\the\value{nfcorrection}body\endcsname\BODY
      }{%
        % Mode none : ne rien afficher
      }%
    }%
  }%

  % Compatibilité avec l'ancien système
  \if@correction
    \expandafter\ifstrequal\expandafter{\@nfcorrection}{none}{%
      % Si nouvelle variable = none mais ancienne option = true, forcer inline
      \begin{tcolorbox}[
        enhanced,
        breakable=false,
        colback=nfcolbglight,
        colframe=nfcolpartie,
        arc=3pt,
        boxrule=1pt,
        left=5pt,
        right=5pt,
        top=5pt,
        bottom=5pt,
        title={\small\textcolor{nfcolpartie}{\faCheck\ Correction}},
        fonttitle=\bfseries,
        coltitle=nfcolpartie,
        attach boxed title to top left={yshift=-2mm, xshift=5mm},
        boxed title style={
          colback=white,
          colframe=nfcolpartie,
          boxrule=1pt,
          arc=2pt
        }
      ]
      \BODY
      \end{tcolorbox}
    }{}%
  \fi
  \if@correctionfin
    \expandafter\ifstrequal\expandafter{\@nfcorrection}{none}{%
      % Si nouvelle variable = none mais ancienne option = true, forcer end
      \stepcounter{nfcorrection}%
      \expandafter\xdef\csname nfcorr\the\value{nfcorrection}partie\endcsname{\Roman{nfpartie}}%
      \expandafter\xdef\csname nfcorr\the\value{nfcorrection}exo\endcsname{\arabic{nfexercice}}%
      \expandafter\xdef\csname nfcorr\the\value{nfcorrection}quest\endcsname{\alph{nfquestion}}%
      \expandafter\global\expandafter\let\csname nfcorr\the\value{nfcorrection}body\endcsname\BODY
    }{}%
  \fi
}

\endinput