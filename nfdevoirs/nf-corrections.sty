% ============================================================================
% nf-corrections.sty - Système de corrections pour nfdevoirs
% Contient l'environnement correction et les modes inline/fin
% ============================================================================

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{nfdevoirs/nf-corrections}[2025/10/02 Système de corrections nfdevoirs]

% ============================================================================
% PACKAGES REQUIS
% ============================================================================
\RequirePackage{tcolorbox}
\RequirePackage{environ}
\RequirePackage{fontawesome5}

% Configuration tcolorbox pour les corrections
\tcbuselibrary{skins,breakable}

% ============================================================================
% ENVIRONNEMENT CORRECTION
% ============================================================================
\NewEnviron{correction}{%
    % Nouveau système basé sur @nfcorrection
    \expandafter\ifstrequal\expandafter{\@nfcorrection}{inline}{%
        % Mode inline : afficher directement
        \begin{tcolorbox}[
                enhanced,
                breakable=false,
                colback=nfcolbglight,
                colframe=nfcolpartie,
                arc=3pt,
                boxrule=1pt,
                left=5pt,
                right=5pt,
                top=5pt,
                bottom=5pt,
                title={\small\textcolor{nfcolpartie}{\faCheck\ Correction}},
                fonttitle=\bfseries,
                coltitle=nfcolpartie,
                attach boxed title to top left={yshift=-2mm, xshift=5mm},
                boxed title style={
                        colback=white,
                        colframe=nfcolpartie,
                        boxrule=1pt,
                        arc=2pt
                    }
            ]
            \BODY
        \end{tcolorbox}
    }{%
        \expandafter\ifstrequal\expandafter{\@nfcorrection}{end}{%
            % Mode fin : stocker chaque correction dans sa propre macro
            \stepcounter{nfcorrection}%
            % Stocker les infos de localisation
            \expandafter\xdef\csname nfcorr\the\value{nfcorrection}partie\endcsname{\Roman{nfpartie}}%
            \expandafter\xdef\csname nfcorr\the\value{nfcorrection}exo\endcsname{\arabic{nfexercice}}%
            \expandafter\xdef\csname nfcorr\the\value{nfcorrection}quest\endcsname{\alph{nfquestion}}%
            % Stocker le contenu de la correction
            \expandafter\global\expandafter\let\csname nfcorr\the\value{nfcorrection}body\endcsname\BODY
        }{%
            \expandafter\ifstrequal\expandafter{\@nfcorrection}{only}{%
                % Mode only : stocker comme pour end, sera affiché en fin sans page de garde
                \stepcounter{nfcorrection}%
                % Stocker les infos de localisation
                \expandafter\xdef\csname nfcorr\the\value{nfcorrection}partie\endcsname{\Roman{nfpartie}}%
                \expandafter\xdef\csname nfcorr\the\value{nfcorrection}exo\endcsname{\arabic{nfexercice}}%
                \expandafter\xdef\csname nfcorr\the\value{nfcorrection}quest\endcsname{\alph{nfquestion}}%
                % Stocker le contenu de la correction
                \expandafter\global\expandafter\let\csname nfcorr\the\value{nfcorrection}body\endcsname\BODY
            }{%
                % Mode none : ne rien afficher
            }%
        }%
    }%

    % Compatibilité avec l'ancien système
    \if@correction
    \expandafter\ifstrequal\expandafter{\@nfcorrection}{none}{%
            % Si nouvelle variable = none mais ancienne option = true, forcer inline
            \begin{tcolorbox}[
                    enhanced,
                    breakable=false,
                    colback=nfcolbglight,
                    colframe=nfcolpartie,
                    arc=3pt,
                    boxrule=1pt,
                    left=5pt,
                    right=5pt,
                    top=5pt,
                    bottom=5pt,
                    title={\small\textcolor{nfcolpartie}{\faCheck\ Correction}},
                    fonttitle=\bfseries,
                    coltitle=nfcolpartie,
                    attach boxed title to top left={yshift=-2mm, xshift=5mm},
                    boxed title style={
                            colback=white,
                            colframe=nfcolpartie,
                            boxrule=1pt,
                            arc=2pt
                        }
                ]
                \BODY
            \end{tcolorbox}
        }{}%
    \fi
    \if@correctionfin
    \expandafter\ifstrequal\expandafter{\@nfcorrection}{none}{%
            % Si nouvelle variable = none mais ancienne option = true, forcer end
            \stepcounter{nfcorrection}%
            \expandafter\xdef\csname nfcorr\the\value{nfcorrection}partie\endcsname{\Roman{nfpartie}}%
            \expandafter\xdef\csname nfcorr\the\value{nfcorrection}exo\endcsname{\arabic{nfexercice}}%
            \expandafter\xdef\csname nfcorr\the\value{nfcorrection}quest\endcsname{\alph{nfquestion}}%
            \expandafter\global\expandafter\let\csname nfcorr\the\value{nfcorrection}body\endcsname\BODY
        }{}%
    \fi
}

% ============================================================================
% COMMANDE POUR AFFICHER TOUTES LES CORRECTIONS EN FIN DE DOCUMENT
% ============================================================================
\newcommand{\nfaffichercorrections}{%
    % Nouveau système : vérifier @nfcorrection=end ou only
    \expandafter\ifstrequal\expandafter{\@nfcorrection}{end}{%
        \ifnum\value{nfcorrection}>0
            \clearpage
            \section*{\faClipboardCheck\ Corrections}
            \nfaffichercorrectionsloop
        \fi
    }{%
        \expandafter\ifstrequal\expandafter{\@nfcorrection}{only}{%
            \ifnum\value{nfcorrection}>0
                % Mode only : pas de clearpage, directement les corrections avec titre du devoir
                \section*{\faClipboardCheck\ Corrections -- \@title}
                \nfaffichercorrectionsloop
            \fi
        }{%
            % Ancien système : compatibilité avec @correctionfin
            \if@correctionfin
                \ifnum\value{nfcorrection}>0
                    \clearpage
                    \section*{\faClipboardCheck\ Corrections}
                    \nfaffichercorrectionsloop
                \fi
            \fi
        }%
    }%
}

% Factorisation de la boucle d'affichage
\newcommand{\nfaffichercorrectionsloop}{%
    % Variables pour suivre la hiérarchie
    \def\nfcurrentpartie{}%
    \def\nfcurrentexercice{}%

    % Boucle principale pour afficher les corrections avec hiérarchie
    \count@=1\relax
    \loop\ifnum\count@<\numexpr\value{nfcorrection}+1\relax
    % Récupérer les infos de la correction actuelle
    \edef\nfthispartie{\csname nfcorr\the\count@ partie\endcsname}%
    \edef\nfthisexercice{\csname nfcorr\the\count@ exo\endcsname}%
    \edef\nfthisquestion{\csname nfcorr\the\count@ quest\endcsname}%

    % Afficher titre de partie si changement
    \ifx\nfcurrentpartie\nfthispartie\else
        \vspace{1em}%
        {\Large\textbf{\color{nfcolpartie}\faLayerGroup\ Partie \nfthispartie}}%
        \vspace{0.5em}%
        \let\nfcurrentpartie\nfthispartie%
        \def\nfcurrentexercice{}% Reset exercice
    \fi

    % Afficher titre d'exercice si changement
    \ifx\nfcurrentexercice\nfthisexercice\else
        \vspace{0.5em}%
        \noindent\hspace{1em}{\large\textbf{\color{nfcolexercice}\faEdit\ Exercice \nfthisexercice}}%
        \vspace{0.3em}%
        \let\nfcurrentexercice\nfthisexercice%
    \fi

    % Afficher la correction avec titre intégré
    \noindent\hspace{2em}%
    \begin{minipage}{\dimexpr\textwidth-2em\relax}
        \begin{tcolorbox}[
                enhanced,
                breakable=false,
                colback=nfcolbglight,
                colframe=nfcolpartie,
                arc=3pt,
                boxrule=1pt,
                left=5pt,
                right=5pt,
                top=5pt,
                bottom=5pt,
                title={\small\textcolor{nfcolpartie}{\faCheck\ Correction question \nfthisquestion}},
                fonttitle=\bfseries,
                coltitle=nfcolpartie,
                attach boxed title to top left={yshift=-2mm, xshift=5mm},
                boxed title style={
                        colback=white,
                        colframe=nfcolpartie,
                        boxrule=1pt,
                        arc=2pt
                    }
            ]
            \csname nfcorr\the\count@ body\endcsname
        \end{tcolorbox}
    \end{minipage}%

    \vspace{0.3em}%
    \advance\count@ by 1\relax
    \repeat
}

\endinput