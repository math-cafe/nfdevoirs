% ============================================================================
% nf-question.sty - Environnement question pour nfdevoirs
% Contient l'environnement question avec système de points et difficulté
% ============================================================================

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{nfdevoirs/nf-question}[2025/10/06 Environnement question nfdevoirs]

% ============================================================================
% PACKAGES REQUIS
% ============================================================================
\RequirePackage{environ}
\RequirePackage{etoolbox}
\RequirePackage{keyval}
\RequirePackage{fontawesome5}

% ============================================================================
% ENVIRONNEMENT QUESTION
% ============================================================================

% Configuration des clés pour l'environnement question
\define@key{nfquestion}{points}{\setcounter{nfptsquestion}{#1}}
\define@key{nfquestion}{bonus}{\setcounter{nfbonusquestion}{#1}}
\define@key{nfquestion}{niveau}{\setcounter{nfniveauquestion}{#1}}

% Commande pour afficher les étoiles de difficulté
\newcommand{\nfafficheniveau}[1]{%
    \ifnum#1>0
        \par\vspace{2pt}
        {\tiny\color{nfcolpoints}%
            \ifcase#1
            \or \faStar\faIcon[regular]{star}\faIcon[regular]{star}\faIcon[regular]{star}\faIcon[regular]{star}% 1 étoile
            \or \faStar\faStar\faIcon[regular]{star}\faIcon[regular]{star}\faIcon[regular]{star}% 2 étoiles
            \or \faStar\faStar\faStar\faIcon[regular]{star}\faIcon[regular]{star}% 3 étoiles
            \or \faStar\faStar\faStar\faStar\faIcon[regular]{star}% 4 étoiles
            \or \faStar\faStar\faStar\faStar\faStar% 5 étoiles
            \fi
        }
    \fi
}

\NewEnviron{question}[1]{%
    % Valeurs par défaut
    \stepcounter{nfquestion}%
    \setcounter{nfptsquestion}{0}%
    \setcounter{nfbonusquestion}{0}%
    \setcounter{nfniveauquestion}{0}%
    % Parse des options key-value
    \setkeys{nfquestion}{#1}%
    % Ajout aux totaux de l'exercice
    \addtocounter{nfptsexercice}{\value{nfptsquestion}}%
    \addtocounter{nfbonusexercice}{\value{nfbonusquestion}}%
    % Structure conditionnelle : masquée en mode correction=only
    \expandafter\ifstrequal\expandafter{\@nfcorrection}{only}{%
        % Mode only : ne pas afficher le contenu de la question
    }{%
        \expandafter\ifstrequal\expandafter{\@nfbareme}{false}{%
            % Mode sans barème : contenu sur toute la largeur
            \noindent
            \textbf{\alph{nfquestion})} \BODY
            \par\medskip
        }{%
            % Mode avec barème : structure en deux colonnes
            \noindent
            \begin{minipage}[t]{\dimexpr\textwidth-3cm\relax}
                \textbf{\alph{nfquestion})} \BODY
            \end{minipage}%
            \hfill
            \begin{minipage}[t]{2.5cm}
                \raggedleft
                \textbf{%
                    \color{nfcolpoints}%
                    \ifnum\value{nfptsquestion}>0 /\the\value{nfptsquestion}\fi%
                    \ifnum\value{nfbonusquestion}>0 \space +\the\value{nfbonusquestion}\fi%
                }
                \nfafficheniveau{\value{nfniveauquestion}}
            \end{minipage}%
            \par\medskip
        }%
    }
}

\endinput